#!/bin/bash

# User data script for Flask application
# Proyecto Final - Universidad Unitec

set -e

# Update system
dnf update -y

# Install Python 3 and pip
dnf install -y python3 python3-pip git curl wget

# Create application directory
mkdir -p /opt/app
cd /opt/app

# Create virtual environment
python3 -m venv venv
source venv/bin/activate

# Install Python packages
pip install Flask pandas boto3 gunicorn

# Create simple Flask application
cat > app.py << 'EOF'
import os
import pandas as pd
import boto3
from flask import Flask, jsonify
import logging

app = Flask(__name__)
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

S3_BUCKET = os.environ.get('DATASET_S3_BUCKET', '${dataset_bucket_name}')
S3_KEY = os.environ.get('DATASET_S3_KEY', '${dataset_s3_key}')

@app.route('/')
def index():
    return '''
    <html>
    <head><title>Dashboard Ciberseguridad - Unitec</title></head>
    <body>
        <h1>ğŸ›¡ï¸ Dashboard de Ciberseguridad</h1>
        <p>Proyecto Final - Universidad Unitec</p>
        <p>Bucket: ''' + S3_BUCKET + '''</p>
        <p>Key: ''' + S3_KEY + '''</p>
        <p><a href="/health">Health Check</a></p>
    </body>
    </html>
    '''

@app.route('/health')
def health():
    return jsonify({
        'status': 'healthy',
        'bucket': S3_BUCKET,
        'key': S3_KEY
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=80, debug=False)
EOF

# Create systemd service
cat > /etc/systemd/system/cyber-dashboard.service << 'EOF'
[Unit]
Description=Cybersecurity Dashboard Flask App
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/app
Environment=DATASET_S3_BUCKET=${dataset_bucket_name}
Environment=DATASET_S3_KEY=${dataset_s3_key}
ExecStart=/opt/app/venv/bin/gunicorn --bind 0.0.0.0:80 --workers 2 app:app
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
systemctl daemon-reload
systemctl enable cyber-dashboard.service
systemctl start cyber-dashboard.service

echo "$(date) - User data script completed" >> /var/log/user-data.log